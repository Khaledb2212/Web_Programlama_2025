@model BookAppointmentVm
@using System.Globalization

@{
    ViewData["Title"] = "Book Appointment";
}

<div class="mx-auto max-w-6xl px-4 py-8">
    <div class="flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
        <div>
            <h1 class="text-2xl font-semibold tracking-tight text-slate-900">Book an Appointment</h1>
            <p class="mt-1 text-sm text-slate-600">Choose a service, then pick an available slot.</p>
        </div>

        <a asp-action="MyAppointments"
           class="inline-flex items-center justify-center rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-900 shadow-sm hover:bg-slate-50">
            My Appointments
        </a>
    </div>

    <!-- Service picker (GET) -->
    <div class="mt-6 rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
        <form asp-controller="AppointmentsMvc" asp-action="Book" method="get" class="flex flex-col gap-3 sm:flex-row sm:items-end">
            <div class="flex-1">
                <label class="text-sm font-medium text-slate-700">Service</label>
                <select name="serviceId"
                        class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500">
                    <option value="0">Select a service...</option>
                    @if (Model?.Services != null)
                    {
                        foreach (var s in Model.Services)
                        {
                                    <option value="@s.Value" selected="@(s.Selected ? "selected" : null)">@s.Text</option>
                        }
                    }
                </select>
            </div>

            <button type="submit"
                    class="inline-flex items-center justify-center rounded-xl bg-emerald-600 px-5 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-emerald-500">
                Load availability
            </button>
        </form>
    </div>

    <!-- Booking form (POST) -->
    <div class="mt-6 grid gap-6 lg:grid-cols-3">
        <!-- Slots -->
        <div class="lg:col-span-2 rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-slate-900">Available Slots</h2>
                <span class="text-xs text-slate-500">Next 7 days</span>
            </div>

            @if (Model == null || Model.ServiceId == 0)
            {
                    <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 p-4 text-sm text-slate-700">
                        Select a service to see available slots.
                    </div>
            }
            else if (Model.AvailableSlots == null || !Model.AvailableSlots.Any())
            {
                    <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 p-4 text-sm text-slate-700">
                        No available slots found for this service in the next 7 days.
                    </div>
            }
            else
            {
                var grouped = Model.AvailableSlots
                    .GroupBy(s => s.Date.Date)
                    .OrderBy(g => g.Key);

                    <div class="mt-4 space-y-5">
                    @foreach (var day in grouped)
                    {
                                <div class="rounded-2xl border border-slate-200 overflow-hidden">
                                    <div class="flex items-center justify-between bg-slate-50 px-4 py-3">
                                        <p class="text-sm font-semibold text-slate-900">
                                    @day.Key.ToString("dddd, dd MMM yyyy", CultureInfo.InvariantCulture)
                                        </p>
                                        <p class="text-xs text-slate-500">@day.Count() slot(s)</p>
                                    </div>

                                    <div class="divide-y divide-slate-200">
                                @foreach (var slot in day.OrderBy(x => x.TrainerName))
                                {
                                                <button type="button"
                                                        class="w-full px-4 py-3 text-left hover:bg-slate-50 focus:outline-none focus:bg-slate-50"
                                                        data-trainer-id="@slot.TrainerId"
                                                        data-date="@slot.Date.ToString("yyyy-MM-dd")"
                                                        data-start="@slot.StartTime"
                                                        data-end="@slot.EndTime"
                                                        data-trainer-name="@slot.TrainerName">
                                                    <div class="flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between">
                                                        <div class="flex items-center gap-2">
                                                            <span class="inline-flex h-9 w-9 items-center justify-center rounded-xl bg-emerald-50 text-emerald-700 font-semibold">
                                                    @((slot.TrainerName ?? "T").First())
                                                            </span>
                                                            <div>
                                                                <p class="text-sm font-semibold text-slate-900">@slot.TrainerName</p>
                                                                <p class="text-xs text-slate-600">Trainer</p>
                                                            </div>
                                                        </div>

                                                        <div class="mt-2 sm:mt-0">
                                                            <span class="inline-flex items-center rounded-xl border border-slate-200 bg-white px-3 py-1 text-sm font-semibold text-slate-900">
                                                    @slot.StartTime - @slot.EndTime
                                                            </span>
                                                        </div>
                                                    </div>
                                                </button>
                                }
                                    </div>
                                </div>
                    }
                    </div>
            }
        </div>

        <!-- Summary + Submit -->
        <div class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
            <h2 class="text-lg font-semibold text-slate-900">Your Selection</h2>
            <p class="mt-1 text-sm text-slate-600">Pick a slot on the left, then confirm.</p>

            <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 p-4">
                <div class="text-sm">
                    <p class="text-slate-700">Trainer</p>
                    <p id="selTrainer" class="mt-1 font-semibold text-slate-900">—</p>
                </div>

                <div class="mt-3 grid grid-cols-2 gap-3 text-sm">
                    <div>
                        <p class="text-slate-700">Date</p>
                        <p id="selDate" class="mt-1 font-semibold text-slate-900">—</p>
                    </div>
                    <div>
                        <p class="text-slate-700">Time</p>
                        <p id="selTime" class="mt-1 font-semibold text-slate-900">—</p>
                    </div>
                </div>
            </div>

            <form asp-controller="AppointmentsMvc" asp-action="Book" method="post" class="mt-4">
                @Html.AntiForgeryToken()

                <!-- These must match your VM property names -->
                <input asp-for="ServiceId" type="hidden" />
                <input asp-for="TrainerId" type="hidden" id="TrainerId" />
                <input asp-for="Date" type="hidden" id="Date" />
                <input asp-for="StartTime" type="hidden" id="StartTime" />
                <input asp-for="EndTime" type="hidden" id="EndTime" />

                <div asp-validation-summary="All"
                     class="mb-3 rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700"></div>

                <button id="confirmBtn" type="submit" disabled
                        class="w-full rounded-xl bg-emerald-600 px-5 py-3 text-sm font-semibold text-white shadow-sm hover:bg-emerald-500 disabled:cursor-not-allowed disabled:bg-slate-300">
                    Confirm booking
                </button>

                <p class="mt-3 text-xs text-slate-500">
                    If booking fails, you’ll see the API error message above.
                </p>
            </form>
        </div>
    </div>
</div>

@section Scripts {
        <partial name="_ValidationScriptsPartial" />
        <script>
            (function () {
                const buttons = document.querySelectorAll('[data-trainer-id]');
                const trainerId = document.getElementById('TrainerId');
                const date = document.getElementById('Date');
                const start = document.getElementById('StartTime');
                const end = document.getElementById('EndTime');
                const confirmBtn = document.getElementById('confirmBtn');

                const selTrainer = document.getElementById('selTrainer');
                const selDate = document.getElementById('selDate');
                const selTime = document.getElementById('selTime');

                function normalizeTime(t) {
                    // TimeSpan binder usually accepts "HH:mm" or "HH:mm:ss"
                    if (!t) return "";
                    return t.length === 5 ? (t + ":00") : t; // "09:00" -> "09:00:00"
                }

                buttons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const tId = btn.getAttribute('data-trainer-id');
                        const d = btn.getAttribute('data-date');
                        const s = btn.getAttribute('data-start');
                        const e = btn.getAttribute('data-end');
                        const tName = btn.getAttribute('data-trainer-name');

                        trainerId.value = tId;
                        date.value = d;
                        start.value = normalizeTime(s);
                        end.value = normalizeTime(e);

                        selTrainer.textContent = tName || "—";
                        selDate.textContent = d || "—";
                        selTime.textContent = (s && e) ? (s + " - " + e) : "—";

                        confirmBtn.disabled = !(tId && d && s && e);
                    });
                });
            })();
        </script>
}
